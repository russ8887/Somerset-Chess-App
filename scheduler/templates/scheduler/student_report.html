{% extends 'scheduler/base.html' %}
{% load scheduler_extras %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Navigation breadcrumb and back button -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'dashboard' %}?date={{ view_date }}{% if view_coach %}&coach={{ view_coach }}{% endif %}" class="text-decoration-none">
                        <i class="bi bi-house-door me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Student Report</li>
            </ol>
        </nav>

        <!-- Back button -->
        <div class="mb-3">
            <a href="{% url 'dashboard' %}?date={{ view_date }}{% if view_coach %}&coach={{ view_coach }}{% endif %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>

        <!-- Student Report Card -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="bi bi-person-circle me-2"></i>Student Report
                </h4>
            </div>
            <div class="card-body">
                {# Remove error and debug_info blocks as these variables aren't passed from the view #}

                {% if student and term %}
                    <!-- Student Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="text-primary">Student Information</h5>
                            <p class="mb-1"><strong>Name:</strong> {{ student.first_name }} {{ student.last_name }}</p>
                            <p class="mb-1"><strong>Year Level:</strong> {{ student.year_level|default:"Not specified" }}</p>
                            <p class="mb-1"><strong>School Class:</strong> {{ student.school_class|default:"Not specified" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary">Term Information</h5>
                            <p class="mb-1"><strong>Term:</strong> {{ term.name }}</p>
                            <p class="mb-1"><strong>Period:</strong> {{ term.start_date|date:"d M Y" }} - {{ term.end_date|date:"d M Y" }}</p>
                        </div>
                    </div>

                    <!-- Attendance Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary">Attendance Summary</h5>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="bi bi-check-circle me-1"></i>{{ regular_present_count }} Regular Present
                                </span>
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="bi bi-thermometer-half me-1"></i>{{ sick_present_count }} Sick but Present
                                </span>
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                    <i class="bi bi-exclamation-triangle me-1"></i>{{ refuses_present_count }} Present but Refuses
                                </span>
                                <span class="badge bg-info fs-6 px-3 py-2">
                                    <i class="bi bi-person-plus me-1"></i>{{ fill_in_count }} Fill-in Lessons
                                </span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="bi bi-x-circle me-1"></i>{{ absent_count }} Total Absent
                                </span>
                                {% if sick_absent_count > 0 %}
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="bi bi-thermometer me-1"></i>{{ sick_absent_count }} Sick
                                </span>
                                {% endif %}
                                {% if teacher_refusal_count > 0 %}
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="bi bi-person-x me-1"></i>{{ teacher_refusal_count }} Teacher Refusal
                                </span>
                                {% endif %}
                                {% if class_event_count > 0 %}
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="bi bi-calendar-event me-1"></i>{{ class_event_count }} Class Event
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-secondary fs-6 px-3 py-2">
                                    <i class="bi bi-calendar-check me-1"></i>{{ total_attended }} Total Attended
                                </span>
                                <span class="badge bg-secondary fs-6 px-3 py-2">
                                    <i class="bi bi-calendar-event me-1"></i>{{ records|length }} Total Lessons
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Availability Management -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="text-primary mb-0">Student Availability</h5>
                                <div class="btn-group">
                                    <button class="btn btn-success btn-sm" onclick="findBetterSlot({{ student.id }})">
                                        <i class="bi bi-search me-1"></i>Find Better Slot
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" id="editAvailabilityBtn" onclick="toggleAvailabilityEdit()">
                                        <i class="bi bi-pencil me-1"></i>Edit Individual Conflicts
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Availability Legend -->
                            <div class="mb-3">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <span class="badge bg-success fs-6 px-3 py-2">
                                        <i class="bi bi-check-circle me-1"></i>Available
                                    </span>
                                    <span class="badge bg-danger fs-6 px-3 py-2">
                                        <i class="bi bi-x-circle me-1"></i>Class Unavailable (inherited from {{ student.school_class.name|default:"class" }})
                                    </span>
                                    <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                        <i class="bi bi-person-x me-1"></i>Individual Conflict (editable)
                                    </span>
                                </div>
                            </div>
                            
                            <div id="availabilityDisplay" class="mb-3">
                                <p class="text-muted mb-3">
                                    <i class="bi bi-info-circle me-1"></i>
                                    This shows all unavailabilities for {{ student.first_name }}. Class conflicts are inherited from their school class, 
                                    while individual conflicts can be added for specific scheduling needs.
                                </p>
                                
                                <!-- Enhanced Availability Grid -->
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Time Slot</th>
                                                <th>Monday</th>
                                                <th>Tuesday</th>
                                                <th>Wednesday</th>
                                                <th>Thursday</th>
                                                <th>Friday</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for time_slot in time_slots %}
                                            <tr>
                                                <td class="fw-semibold">{{ time_slot }}</td>
                                                {% for day_num in "01234" %}
                                                {% with day_int=day_num|add:0 %}
                                                {% with class_slots=class_unavailable_slots|lookup:day_int %}
                                                {% with individual_slots=individual_unavailable_slots|lookup:day_int %}
                                                <td class="text-center p-2">
                                                    {% comment %}Check if student has a scheduled lesson at this time{% endcomment %}
                                                    {% with has_scheduled_lesson=False %}
                                                    {% for record in records %}
                                                        {% if record.lesson_session.lesson_date.weekday == day_int and record.lesson_session.scheduled_group.time_slot.pk == time_slot.pk %}
                                                            {% with has_scheduled_lesson=True %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    {% if time_slot.pk in class_slots %}
                                                        <span class="badge bg-danger text-white px-2 py-1{% if has_scheduled_lesson %} border border-warning border-3{% endif %}" 
                                                              {% if has_scheduled_lesson %}title="SCHEDULING CONFLICT: Student has lesson but class unavailable!"{% endif %}>
                                                            <i class="bi bi-x-circle"></i> Class
                                                            {% if has_scheduled_lesson %}<i class="bi bi-exclamation-triangle-fill ms-1"></i>{% endif %}
                                                        </span>
                                                    {% elif time_slot.pk in individual_slots %}
                                                        <span class="badge bg-warning text-dark px-2 py-1{% if has_scheduled_lesson %} border border-danger border-3{% endif %}"
                                                              {% if has_scheduled_lesson %}title="SCHEDULING CONFLICT: Student has lesson but individually unavailable!"{% endif %}>
                                                            <i class="bi bi-person-x"></i> Individual
                                                            {% if has_scheduled_lesson %}<i class="bi bi-exclamation-triangle-fill ms-1"></i>{% endif %}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-success text-white px-2 py-1">
                                                            <i class="bi bi-check-circle"></i> Available
                                                        </span>
                                                    {% endif %}
                                                    {% endwith %}
                                                </td>
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Summary badges -->
                                <div class="d-flex flex-wrap gap-2 mt-3">
                                    {% if class_unavailabilities %}
                                        <span class="badge bg-danger fs-6 px-3 py-2">
                                            <i class="bi bi-building me-1"></i>{{ class_unavailabilities|length }} Class Conflicts
                                        </span>
                                    {% endif %}
                                    {% if individual_unavailabilities %}
                                        <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                            <i class="bi bi-person me-1"></i>{{ individual_unavailabilities|length }} Individual Conflicts
                                        </span>
                                    {% endif %}
                                    {% if not class_unavailabilities and not individual_unavailabilities %}
                                        <span class="badge bg-success fs-6 px-3 py-2">
                                            <i class="bi bi-check-circle me-1"></i>No Scheduling Conflicts
                                        </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div id="availabilityEditForm" class="d-none">
                                <form method="post" action="{% url 'manage-student-availability' student.pk %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="return_url" value="{{ request.get_full_path }}">
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Time Slot</th>
                                                    <th>Monday</th>
                                                    <th>Tuesday</th>
                                                    <th>Wednesday</th>
                                                    <th>Thursday</th>
                                                    <th>Friday</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for time_slot in time_slots %}
                                                <tr>
                                                    <td class="fw-semibold">{{ time_slot }}</td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="unavailable_{{ time_slot.pk }}_0"
                                                               class="form-check-input"
                                                               {% if 0 in unavailable_slots and time_slot.pk in unavailable_slots.0 %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="unavailable_{{ time_slot.pk }}_1"
                                                               class="form-check-input"
                                                               {% if 1 in unavailable_slots and time_slot.pk in unavailable_slots.1 %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="unavailable_{{ time_slot.pk }}_2"
                                                               class="form-check-input"
                                                               {% if 2 in unavailable_slots and time_slot.pk in unavailable_slots.2 %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="unavailable_{{ time_slot.pk }}_3"
                                                               class="form-check-input"
                                                               {% if 3 in unavailable_slots and time_slot.pk in unavailable_slots.3 %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" 
                                                               name="unavailable_{{ time_slot.pk }}_4"
                                                               class="form-check-input"
                                                               {% if 4 in unavailable_slots and time_slot.pk in unavailable_slots.4 %}checked{% endif %}>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-1"></i>Save Availability
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleAvailabilityEdit()">
                                            <i class="bi bi-x-circle me-1"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lesson Records Table -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="text-primary">Lesson History</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in records %}
                                            <tr>
                                                <td>
                                                    <strong>{{ record.lesson_session.lesson_date|date:"d M Y" }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ record.lesson_session.lesson_date|date:"l" }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge {% if record.status == 'PRESENT' or record.status == 'FILL_IN' or record.status == 'SICK_PRESENT' %}bg-success{% elif record.status == 'REFUSES_PRESENT' %}bg-warning text-dark{% elif record.status == 'ABSENT' %}bg-danger{% else %}bg-secondary{% endif %} fs-6">
                                                        {% if record.status == 'SICK_PRESENT' %}
                                                            <i class="bi bi-thermometer-half me-1"></i>
                                                        {% elif record.status == 'REFUSES_PRESENT' %}
                                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                                        {% elif record.status == 'PRESENT' %}
                                                            <i class="bi bi-check-circle me-1"></i>
                                                        {% elif record.status == 'ABSENT' %}
                                                            <i class="bi bi-x-circle me-1"></i>
                                                        {% elif record.status == 'FILL_IN' %}
                                                            <i class="bi bi-person-plus me-1"></i>
                                                        {% endif %}
                                                        {{ record.get_status_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if record.status == 'ABSENT' and record.reason_for_absence %}
                                                        <div class="mb-2">
                                                            <strong class="text-danger">Absence Reason:</strong> 
                                                            <span class="badge bg-light text-dark">{{ record.get_reason_for_absence_display }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {# Safely check for lesson notes without causing RelatedObjectDoesNotExist #}
                                                    {% if record.lessonnote %}
                                                        {% if record.lessonnote.topics_covered %}
                                                            <div class="mb-1">
                                                                <strong class="text-info">Topics:</strong>
                                                                <span class="text-muted">{{ record.lessonnote.topics_covered }}</span>
                                                            </div>
                                                        {% endif %}
                                                        {% if record.lessonnote.coach_comments %}
                                                            <div class="mb-1">
                                                                <strong class="text-success">Comments:</strong>
                                                                <span class="text-muted">{{ record.lessonnote.coach_comments }}</span>
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if not record.reason_for_absence and not record.lessonnote %}
                                                        <span class="text-muted fst-italic">No additional details</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted py-4">
                                                    <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                                                    No lesson records found for this student in this term.
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Information Missing:</strong> Student or term information is not available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Toggle availability editing form
function toggleAvailabilityEdit() {
    const displayDiv = document.getElementById('availabilityDisplay');
    const editForm = document.getElementById('availabilityEditForm');
    const editBtn = document.getElementById('editAvailabilityBtn');
    
    if (editForm.classList.contains('d-none')) {
        // Show edit form
        displayDiv.classList.add('d-none');
        editForm.classList.remove('d-none');
        editBtn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Cancel';
    } else {
        // Show display
        displayDiv.classList.remove('d-none');
        editForm.classList.add('d-none');
        editBtn.innerHTML = '<i class="bi bi-pencil me-1"></i>Edit Individual Conflicts';
    }
}

// Find better slot functionality with enhanced progress tracking
function findBetterSlot(studentId) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Analyzing... Please wait';
    button.disabled = true;
    
    // Show progress notification with timeout warning
    const progressNotification = showNotification(
        'Starting intelligent slot analysis. This comprehensive analysis may take several minutes for the best results. Please be patient...', 
        'info', 
        false // Don't auto-dismiss
    );
    
    // Start progress animation
    let progressDots = 0;
    const progressInterval = setInterval(() => {
        progressDots = (progressDots + 1) % 4;
        const dots = '.'.repeat(progressDots);
        button.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>Analyzing${dots} Please wait`;
    }, 500);
    
    // Make AJAX request to find better slots
    fetch(`/api/find-better-slot/${studentId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        // Clear progress animation
        clearInterval(progressInterval);
        
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Remove progress notification
        if (progressNotification && progressNotification.parentNode) {
            progressNotification.remove();
        }
        
        if (data.success) {
            // Show success message with timing
            showNotification(
                `${data.message || 'Analysis complete!'} (Completed in ${data.analysis_time || 'unknown time'})`, 
                'success'
            );
            
            if (data.recommendations && data.recommendations.length > 0) {
                showSlotRecommendations(data.recommendations, data.student_name);
            } else {
                showInfo(`No better slots found for ${data.student_name || 'this student'}. Current placement appears optimal!`);
            }
        } else {
            showError(data.error || 'Failed to find better slots');
        }
    })
    .catch(error => {
        // Clear progress animation
        clearInterval(progressInterval);
        
        // Restore button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Remove progress notification
        if (progressNotification && progressNotification.parentNode) {
            progressNotification.remove();
        }
        
        // Show user-friendly error message
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showError('Connection error. Please check your internet connection and try again.');
        } else {
            showError('Analysis failed due to a technical issue. Please try again in a moment.');
        }
        
        console.error('Slot finder error:', error);
    });
}

// Show slot recommendations modal with enhanced pairing details
function showSlotRecommendations(recommendations, studentName) {
    if (recommendations.length === 0) {
        showInfo('No alternative slots found at this time. Current placement appears optimal!');
        return;
    }
    
    // Categorize recommendations
    let improvements = recommendations.filter(r => r.placement_type !== 'alternative');
    let alternatives = recommendations.filter(r => r.placement_type === 'alternative');
    
    // Determine modal title and message
    let modalTitle, modalMessage, headerClass;
    if (improvements.length > 0) {
        modalTitle = 'Better Slots Found for ' + (studentName || 'this student') + '!';
        modalMessage = `Found ${improvements.length} improved option(s)` + 
                      (alternatives.length > 0 ? ` and ${alternatives.length} alternative option(s)` : '') + ':';
        headerClass = 'bg-success';
    } else {
        modalTitle = 'Alternative Slots Available for ' + (studentName || 'this student');
        modalMessage = `Found ${alternatives.length} alternative placement option(s) of similar quality:`;
        headerClass = 'bg-info';
    }
    
    // Create modal content
    let modalContent = '<div class="modal fade" id="slotRecommendationsModal" tabindex="-1">' +
        '<div class="modal-dialog modal-xl">' +
        '<div class="modal-content">' +
        '<div class="modal-header ' + headerClass + ' text-white">' +
        '<h5 class="modal-title">' +
        '<i class="bi bi-search me-2"></i>' + modalTitle +
        '</h5>' +
        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<p class="mb-3">' + modalMessage + '</p>';
    
    recommendations.forEach((rec, index) => {
        const badgeClass = rec.placement_type === 'direct' ? 'bg-success' : 
                          rec.placement_type === 'displacement' ? 'bg-warning' : 
                          rec.placement_type === 'swap' ? 'bg-info' : 'bg-secondary';
        
        let buttonText = 'Move to This Slot';
        let placementDescription = '';
        let pairingInfo = '';
        
        // Extract rich pairing information from displacement_info
        if (rec.displacement_info) {
            if (rec.displacement_info.pairing_info) {
                pairingInfo = rec.displacement_info.pairing_info;
            }
            
            if (rec.displacement_info.priority_reason) {
                placementDescription = rec.displacement_info.priority_reason;
            }
        }
        
        if (rec.placement_type === 'direct') {
            buttonText = 'Direct Move';
            if (!placementDescription) placementDescription = 'Direct placement in available slot';
        } else if (rec.placement_type === 'displacement') {
            buttonText = 'Execute Displacement';
            if (!placementDescription) placementDescription = 'Displace another student for better fit';
        } else if (rec.placement_type === 'swap') {
            buttonText = 'Execute Swap (2 students)';
            placementDescription = 'Swap with 1 other student';
        } else if (rec.placement_type === 'chain') {
            buttonText = `Execute Chain Move (${rec.chain_length} students)`;
            placementDescription = `Chain of ${rec.chain_length} moves affecting ${rec.affected_students} students`;
        }
        
        modalContent += '<div class="card mb-3 border-' + (rec.placement_type === 'direct' ? 'success' : 'primary') + '">' +
            '<div class="card-header d-flex justify-content-between align-items-center">' +
            '<div>' +
            '<strong>' + rec.group_name + '</strong>' +
            '<span class="badge ' + badgeClass + ' ms-2">' + rec.placement_type.toUpperCase() + '</span>' +
            '</div>' +
            '<div class="text-end">' +
            '<div class="h5 mb-0 text-success">' + rec.score + '/370</div>' +
            '<small class="text-muted">' + rec.percentage + '% match</small>' +
            '</div>' +
            '</div>' +
            '<div class="card-body">' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            '<p class="mb-1"><strong>Time:</strong> ' + rec.day_name + ' ' + rec.time_slot + '</p>' +
            '<p class="mb-1"><strong>Coach:</strong> ' + rec.coach_name + '</p>' +
            '<p class="mb-1"><strong>Current Size:</strong> ' + rec.current_size + '/' + rec.max_capacity + '</p>' +
            '</div>' +
            '<div class="col-md-6">' +
            '<p class="mb-1"><strong>Placement:</strong> ' + placementDescription + '</p>' +
            (rec.explanation ? '<p class="mb-1"><strong>Details:</strong> ' + rec.explanation + '</p>' : '') +
            '</div>' +
            '</div>';
        
        // Add rich pairing information if available
        if (pairingInfo) {
            modalContent += '<div class="alert alert-info mt-2 mb-2">' +
                '<h6 class="alert-heading"><i class="bi bi-people me-2"></i>Group Composition</h6>' +
                '<p class="mb-0">' + pairingInfo + '</p>' +
                '</div>';
        }
        
        // Add displacement details if available
        if (rec.displacement_info && rec.displacement_info.displaced_student) {
            const displacedStudent = rec.displacement_info.displaced_student;
            modalContent += '<div class="alert alert-warning mt-2 mb-2">' +
                '<h6 class="alert-heading"><i class="bi bi-arrow-left-right me-2"></i>Displacement Details</h6>' +
                '<p class="mb-0">This move will displace: <strong>' + displacedStudent.student_name + '</strong> (' + 
                displacedStudent.skill_level + ', ' + displacedStudent.enrollment_type + ')</p>' +
                '</div>';
        }
        
        modalContent += '<div class="mt-2">' +
            '<button class="btn btn-primary btn-sm" onclick="executeRecommendation(' + index + ')">' +
            '<i class="bi bi-check-circle me-1"></i>' + buttonText +
            '</button>' +
            '<button class="btn btn-outline-info btn-sm" onclick="showRecommendationDetails(' + index + ')">' +
            '<i class="bi bi-info-circle me-1"></i>View Details' +
            '</button>' +
            '</div>' +
            '</div>' +
            '</div>';
    });
    
    modalContent += '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Remove existing modal if any
    const existingModal = document.getElementById('slotRecommendationsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('slotRecommendationsModal'));
    modal.show();
    
    // Store recommendations for later use
    window.currentRecommendations = recommendations;
}

// Execute a recommendation
function executeRecommendation(index) {
    const rec = window.currentRecommendations[index];
    
    // Show detailed confirmation with placement information
    let confirmMessage = `Are you sure you want to move this student to ${rec.group_name}?\n\n`;
    confirmMessage += `Time: ${rec.day_name} ${rec.time_slot}\n`;
    confirmMessage += `Coach: ${rec.coach_name}\n`;
    confirmMessage += `Current Size: ${rec.current_size}/${rec.max_capacity}\n`;
    confirmMessage += `Compatibility Score: ${rec.score}/370 (${rec.percentage}%)\n`;
    
    if (rec.placement_type === 'swap') {
        confirmMessage += `\nThis will swap with: ${rec.displaced_student}\n`;
    } else if (rec.placement_type === 'chain') {
        confirmMessage += `\nThis requires a chain of ${rec.chain_length} moves affecting ${rec.affected_students} students\n`;
    }
    
    if (confirm(confirmMessage)) {
        executeSlotMove(rec, index);
    }
}

// Execute the actual slot move
function executeSlotMove(rec, index) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Moving...';
    button.disabled = true;
    
    // Disable all other buttons in the modal
    const allButtons = document.querySelectorAll('#slotRecommendationsModal button, #scoreDetailsModal button');
    allButtons.forEach(btn => btn.disabled = true);
    
    // Show progress notification
    const progressNotification = showNotification(
        `Moving student to ${rec.group_name}. Please wait...`, 
        'info', 
        false // Don't auto-dismiss
    );
    
    // Get student ID from the current page context
    const studentId = parseInt('{{ student.id }}');
    
    // Make AJAX request to execute the move
    fetch(`/api/execute-slot-move/${studentId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'group_id': rec.group_id,
            'placement_type': rec.placement_type
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove progress notification
        if (progressNotification && progressNotification.parentNode) {
            progressNotification.remove();
        }
        
        if (data.success) {
            // Show success message
            showNotification(
                `✅ ${data.message}`, 
                'success'
            );
            
            // Close any open modals
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
            
            // Refresh the page after a short delay to show updated information
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            // Show error message
            showError(`❌ ${data.error}`);
            
            // Re-enable buttons
            button.innerHTML = originalText;
            button.disabled = false;
            allButtons.forEach(btn => btn.disabled = false);
        }
    })
    .catch(error => {
        // Remove progress notification
        if (progressNotification && progressNotification.parentNode) {
            progressNotification.remove();
        }
        
        // Show user-friendly error message
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            showError('❌ Connection error. Please check your internet connection and try again.');
        } else {
            showError('❌ Move failed due to a technical issue. Please try again in a moment.');
        }
        
        // Re-enable buttons
        button.innerHTML = originalText;
        button.disabled = false;
        allButtons.forEach(btn => btn.disabled = false);
        
        console.error('Slot move error:', error);
    });
}

// Show recommendation details
function showRecommendationDetails(index) {
    const rec = window.currentRecommendations[index];
    
    if (!rec.score_breakdown) {
        showError('Detailed scoring information not available for this recommendation.');
        return;
    }
    
    showDetailedScoreModal(rec);
}

// Show detailed scoring modal
function showDetailedScoreModal(rec) {
    // Create detailed modal content
    let modalContent = '<div class="modal fade" id="scoreDetailsModal" tabindex="-1">' +
        '<div class="modal-dialog modal-xl">' +
        '<div class="modal-content">' +
        '<div class="modal-header bg-info text-white">' +
        '<h5 class="modal-title">' +
        '<i class="bi bi-graph-up me-2"></i>Detailed Compatibility Analysis' +
        '</h5>' +
        '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<div class="row mb-4">' +
        '<div class="col-md-6">' +
        '<h6 class="text-primary">Recommendation Summary</h6>' +
        '<p><strong>Group:</strong> ' + rec.group_name + '</p>' +
        '<p><strong>Time:</strong> ' + rec.day_name + ' ' + rec.time_slot + '</p>' +
        '<p><strong>Coach:</strong> ' + rec.coach_name + '</p>' +
        '<p><strong>Current Size:</strong> ' + rec.current_size + '/' + rec.max_capacity + '</p>' +
        '<p><strong>Placement Type:</strong> <span class="badge bg-' + 
        (rec.placement_type === 'direct' ? 'success' : rec.placement_type === 'swap' ? 'warning' : 'info') + '">' + 
        rec.placement_type.toUpperCase() + '</span></p>' +
        '</div>' +
        '<div class="col-md-6">' +
        '<h6 class="text-primary">Overall Score</h6>' +
        '<div class="text-center">' +
        '<div class="display-4 text-success mb-2">' + rec.score + '/370</div>' +
        '<div class="h5 text-muted">' + rec.percentage + '% Compatibility</div>' +
        '<div class="progress mb-3" style="height: 20px;">' +
        '<div class="progress-bar bg-success" style="width: ' + rec.percentage + '%"></div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Add detailed scoring breakdown if available
    if (rec.score_breakdown) {
        modalContent += '<div class="row">' +
            '<div class="col-12">' +
            '<h6 class="text-primary">Detailed Scoring Breakdown</h6>' +
            '<div class="table-responsive">' +
            '<table class="table table-striped">' +
            '<thead class="table-dark">' +
            '<tr>' +
            '<th>Criteria</th>' +
            '<th>Score</th>' +
            '<th>Weight</th>' +
            '<th>Weighted Score</th>' +
            '<th>Description</th>' +
            '</tr>' +
            '</thead>' +
            '<tbody>';
        
        // Define scoring criteria with descriptions
        const criteriaInfo = {
            'skill_level': {
                weight: 100,
                description: 'How well student\'s skill level matches group target'
            },
            'year_level': {
                weight: 80,
                description: 'Compatibility with other students\' year levels'
            },
            'group_size_preference': {
                weight: 50,
                description: 'Match between student enrollment type and group type'
            },
            'coach_specialization': {
                weight: 50,
                description: 'Coach\'s expertise with student\'s skill level'
            },
            'lesson_balance': {
                weight: 40,
                description: 'Priority based on student\'s lesson balance'
            },
            'group_capacity': {
                weight: 30,
                description: 'Group\'s need for additional students'
            },
            'time_preference': {
                weight: 20,
                description: 'Student\'s time slot preferences'
            }
        };
        
        // Add rows for each scoring criteria
        Object.keys(criteriaInfo).forEach(criteria => {
            const score = rec.score_breakdown[criteria] || 0;
            const info = criteriaInfo[criteria];
            const weightedScore = Math.round((score / 100) * info.weight);
            
            modalContent += '<tr>' +
                '<td><strong>' + criteria.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</strong></td>' +
                '<td>' +
                '<div class="d-flex align-items-center">' +
                '<span class="me-2">' + score + '/100</span>' +
                '<div class="progress flex-grow-1" style="height: 8px;">' +
                '<div class="progress-bar bg-' + (score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger') + '" ' +
                'style="width: ' + score + '%"></div>' +
                '</div>' +
                '</div>' +
                '</td>' +
                '<td>' + info.weight + '</td>' +
                '<td><strong>' + weightedScore + '</strong></td>' +
                '<td><small class="text-muted">' + info.description + '</small></td>' +
                '</tr>';
        });
        
        modalContent += '</tbody></table></div></div></div>';
    }
    
    // Add placement-specific information
    if (rec.placement_type === 'swap' && rec.displaced_student) {
        modalContent += '<div class="row mt-4">' +
            '<div class="col-12">' +
            '<div class="alert alert-warning">' +
            '<h6><i class="bi bi-arrow-left-right me-2"></i>Swap Details</h6>' +
            '<p>This placement requires swapping with <strong>' + rec.displaced_student + '</strong>.</p>' +
            '<p>Both students will benefit from this arrangement.</p>' +
            '</div>' +
            '</div>' +
            '</div>';
    } else if (rec.placement_type === 'chain' && rec.chain_length) {
        modalContent += '<div class="row mt-4">' +
            '<div class="col-12">' +
            '<div class="alert alert-info">' +
            '<h6><i class="bi bi-diagram-3 me-2"></i>Chain Move Details</h6>' +
            '<p>This placement requires a chain of <strong>' + rec.chain_length + ' moves</strong>.</p>' +
            '<p>Multiple students will be repositioned to optimize overall placement.</p>' +
            '</div>' +
            '</div>' +
            '</div>';
    }
    
    modalContent += '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-primary" onclick="executeRecommendation(' + 
        window.currentRecommendations.indexOf(rec) + ')">' +
        '<i class="bi bi-check-circle me-1"></i>Move to This Slot' +
        '</button>' +
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    // Remove existing modal if any
    const existingModal = document.getElementById('scoreDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page and show
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('scoreDetailsModal'));
    modal.show();
}

// Utility functions for notifications
function showError(message) {
    showNotification(message, 'danger');
}

function showInfo(message) {
    showNotification(message, 'info');
}

function showNotification(message, type, autoDismiss = true) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds (unless disabled)
    if (autoDismiss) {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    return alertDiv; // Return element for manual cleanup
}

console.log('Student report page loaded');
</script>
{% endblock %}
