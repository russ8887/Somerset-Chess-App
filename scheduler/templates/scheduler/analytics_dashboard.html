{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Somerset Chess Scheduler{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .metric-card {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    .progress-bar-custom {
        height: 20px;
        border-radius: 10px;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
                <div class="text-muted">
                    <i class="fas fa-calendar"></i> {{ current_term.name }}
                </div>
            </div>

            {% if error %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                </div>
            {% else %}

            <!-- Enhanced Filter Section -->
            <div class="filter-section">
                <form method="GET" id="analyticsFilterForm">
                    <div class="row">
                        <div class="col-md-12">
                            <h5><i class="fas fa-filter"></i> Analytics Filters</h5>
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quick Date Ranges</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('week')">This Week</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('month')">This Month</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('term')">Full Term</button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Status Filters -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Attendance Status</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="PRESENT" id="status_present"
                                               {% if 'PRESENT' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_present">Present</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="SICK_PRESENT" id="status_sick_present"
                                               {% if 'SICK_PRESENT' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_sick_present">
                                            <span class="badge bg-warning">Present Sick</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="REFUSES_PRESENT" id="status_refuses_present"
                                               {% if 'REFUSES_PRESENT' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_refuses_present">Present but Refuses</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="ABSENT" id="status_absent"
                                               {% if 'ABSENT' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_absent">Absent</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="FILL_IN" id="status_fill_in"
                                               {% if 'FILL_IN' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_fill_in">Fill-in</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="status_filter" value="FILL_IN_ABSENT" id="status_fill_in_absent"
                                               {% if 'FILL_IN_ABSENT' in request.GET.status_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="status_fill_in_absent">Fill-in Absent</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Absence Reason Filters -->
                        <div class="col-md-6">
                            <label class="form-label">Absence Reasons</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="absence_reason_filter" value="SICK" id="reason_sick"
                                               {% if 'SICK' in request.GET.absence_reason_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="reason_sick">Sick</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="absence_reason_filter" value="TEACHER_REFUSAL" id="reason_teacher"
                                               {% if 'TEACHER_REFUSAL' in request.GET.absence_reason_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="reason_teacher">Teacher Refusal</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="absence_reason_filter" value="CLASS_EVENT" id="reason_class_event"
                                               {% if 'CLASS_EVENT' in request.GET.absence_reason_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="reason_class_event">Class Event</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="absence_reason_filter" value="OTHER" id="reason_other"
                                               {% if 'OTHER' in request.GET.absence_reason_filter %}checked{% endif %}>
                                        <label class="form-check-label" for="reason_other">Other</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lesson Balance and Student Status Filters -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="lesson_balance_filter" class="form-label">Lesson Balance</label>
                            <select class="form-select" name="lesson_balance_filter" id="lesson_balance_filter">
                                <option value="">All Students</option>
                                <option value="behind" {% if request.GET.lesson_balance_filter == 'behind' %}selected{% endif %}>Behind Schedule (Owes 1+ lessons)</option>
                                <option value="very_behind" {% if request.GET.lesson_balance_filter == 'very_behind' %}selected{% endif %}>Very Behind (Owes 3+ lessons)</option>
                                <option value="on_track" {% if request.GET.lesson_balance_filter == 'on_track' %}selected{% endif %}>On Track</option>
                                <option value="ahead" {% if request.GET.lesson_balance_filter == 'ahead' %}selected{% endif %}>Ahead (Has Credit)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="student_status_filter" class="form-label">Student Status</label>
                            <select class="form-select" name="student_status_filter" id="student_status_filter">
                                <option value="">All Students</option>
                                <option value="active" {% if request.GET.student_status_filter == 'active' %}selected{% endif %}>Active Only</option>
                                <option value="inactive" {% if request.GET.student_status_filter == 'inactive' %}selected{% endif %}>Inactive Only</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="coach_filter" class="form-label">Coach</label>
                            <select class="form-select" name="coach_filter" id="coach_filter">
                                <option value="">All Coaches</option>
                                {% for coach in available_coaches %}
                                <option value="{{ coach.id }}" {% if request.GET.coach_filter == coach.id|stringformat:"s" %}selected{% endif %}>
                                    {{ coach.user.first_name }} {{ coach.user.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <div class="float-end">
                                <small class="text-muted">
                                    Showing data from {{ start_date|date:'M j, Y' }} to {{ end_date|date:'M j, Y' }}
                                    {% if filtered_student_count %}
                                    | {{ filtered_student_count }} students match filters
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Filtered Students List -->
            {% if filtered_students %}
            <div class="analytics-card">
                <h3><i class="fas fa-filter"></i> Filtered Students ({{ filtered_student_count }})</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Student Name</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Coach</th>
                                <th>Lesson Balance</th>
                                <th>School Class</th>
                                <th>Skill Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student_data in filtered_students %}
                            <tr>
                                <td>
                                    <strong>{{ student_data.student.first_name }} {{ student_data.student.last_name }}</strong>
                                </td>
                                <td>
                                    {% if student_data.record.status == 'SICK_PRESENT' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-thermometer-half me-1"></i>Present Sick
                                        </span>
                                    {% elif student_data.record.status == 'PRESENT' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Present
                                        </span>
                                    {% elif student_data.record.status == 'ABSENT' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Absent
                                        </span>
                                    {% elif student_data.record.status == 'FILL_IN' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-plus me-1"></i>Fill-in
                                        </span>
                                    {% elif student_data.record.status == 'FILL_IN_ABSENT' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-person-x me-1"></i>Fill-in Absent
                                        </span>
                                    {% elif student_data.record.status == 'REFUSES_PRESENT' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Present Refuses
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ student_data.record.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ student_data.record.lesson_session.lesson_date|date:"M j, Y" }}</td>
                                <td>
                                    {% if student_data.record.lesson_session.scheduled_group.coach %}
                                        {{ student_data.record.lesson_session.scheduled_group.coach.user.first_name }} 
                                        {{ student_data.record.lesson_session.scheduled_group.coach.user.last_name }}
                                    {% else %}
                                        <span class="text-muted">No Coach</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% with balance=student_data.lesson_balance %}
                                        {% if balance > 2 %}
                                            <span class="badge bg-danger">{{ balance }} owed</span>
                                        {% elif balance > 0 %}
                                            <span class="badge bg-warning text-dark">{{ balance }} owed</span>
                                        {% elif balance < -2 %}
                                            <span class="badge bg-info">{{ balance|floatformat:0|slice:"1:" }} credit</span>
                                        {% elif balance < 0 %}
                                            <span class="badge bg-success">{{ balance|floatformat:0|slice:"1:" }} credit</span>
                                        {% else %}
                                            <span class="badge bg-success">On track</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if student_data.student.school_class %}
                                        {{ student_data.student.school_class.name }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{% if student_data.student.skill_level == 'B' %}primary{% elif student_data.student.skill_level == 'I' %}warning{% else %}success{% endif %}">
                                        {{ student_data.student.get_skill_level_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Quick Actions for Filtered Students -->
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Showing {{ filtered_student_count }} student{{ filtered_student_count|pluralize }} matching your selected filters.
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-success btn-sm" onclick="exportData()">
                                <i class="fas fa-download me-1"></i>Export This List
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- All Students Overview -->
            <div class="analytics-card">
                <h3><i class="fas fa-users"></i> All Students Overview ({{ all_students_overview|length }})</h3>
                
                <!-- Search/Filter Bar -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="studentSearch" placeholder="Search students..." onkeyup="filterStudents()">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">
                            <i class="fas fa-sort"></i> Click column headers to sort
                        </small>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="studentsOverviewTable">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" data-sort="student_name">
                                    Student Name 
                                    {% if sort_by == 'student_name' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="lessons_owed">
                                    Lessons Owed 
                                    {% if sort_by == 'lessons_owed' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th>Progress</th>
                                <th class="sortable" data-sort="attendance_rate">
                                    Attendance Rate
                                    {% if sort_by == 'attendance_rate' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="coach">
                                    Coach
                                    {% if sort_by == 'coach' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="group_type">
                                    Group Type
                                    {% if sort_by == 'group_type' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="school_class">
                                    Class
                                    {% if sort_by == 'school_class' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="skill_level">
                                    Skill Level
                                    {% if sort_by == 'skill_level' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="last_status">
                                    Last Status
                                    {% if sort_by == 'last_status' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="days_since_last">
                                    Days Since Last
                                    {% if sort_by == 'days_since_last' %}
                                        <i class="fas fa-sort-{{ sort_order == 'asc'|yesno:'up,down' }}"></i>
                                    {% else %}
                                        <i class="fas fa-sort text-muted"></i>
                                    {% endif %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student_data in all_students_overview %}
                            <tr class="student-row" data-student-id="{{ student_data.student.id }}">
                                <td>
                                    <strong>{{ student_data.student_name }}</strong>
                                    <br><small class="text-muted">Year {{ student_data.year_level }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ student_data.balance_color }}">
                                        {% if student_data.lessons_owed > 0 %}
                                            {{ student_data.lessons_owed }} owed
                                        {% elif student_data.lessons_owed < 0 %}
                                            {{ student_data.lessons_owed|floatformat:0|slice:"1:" }} credit
                                        {% else %}
                                            On track
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress progress-bar-custom">
                                        {% widthratio student_data.attended_lessons student_data.target_lessons 100 as progress_pct %}
                                        <div class="progress-bar bg-{% if progress_pct < 50 %}danger{% elif progress_pct < 80 %}warning{% else %}success{% endif %}" 
                                             style="width: {{ progress_pct|default:0 }}%">
                                            {{ student_data.attended_lessons }}/{{ student_data.target_lessons }}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{% if student_data.attendance_rate >= 90 %}success{% elif student_data.attendance_rate >= 75 %}warning{% else %}danger{% endif %}">
                                        {{ student_data.attendance_rate }}%
                                    </span>
                                </td>
                                <td>
                                    <small>{{ student_data.coaches }}</small>
                                </td>
                                <td>
                                    <small>{{ student_data.group_types }}</small>
                                </td>
                                <td>{{ student_data.school_class }}</td>
                                <td>
                                    <span class="badge bg-{% if student_data.student.skill_level == 'B' %}primary{% elif student_data.student.skill_level == 'I' %}warning{% else %}success{% endif %}">
                                        {{ student_data.skill_level }}
                                    </span>
                                </td>
                                <td>
                                    {% if student_data.last_status == 'Sick but Present' %}
                                        <span class="badge bg-warning text-dark editable-status" 
                                              data-student-id="{{ student_data.student.id }}" 
                                              data-current-status="SICK_PRESENT"
                                              title="Click to edit status">
                                            <i class="fas fa-thermometer-half me-1"></i>Present Sick
                                        </span>
                                    {% elif student_data.last_status == 'Present' %}
                                        <span class="badge bg-success editable-status"
                                              data-student-id="{{ student_data.student.id }}"
                                              data-current-status="PRESENT"
                                              title="Click to edit status">
                                            <i class="fas fa-check me-1"></i>Present
                                        </span>
                                    {% elif student_data.last_status == 'Absent' %}
                                        <span class="badge bg-danger editable-status"
                                              data-student-id="{{ student_data.student.id }}"
                                              data-current-status="ABSENT"
                                              title="Click to edit status">
                                            <i class="fas fa-times me-1"></i>Absent
                                        </span>
                                    {% elif student_data.last_status == 'Fill-in' %}
                                        <span class="badge bg-info editable-status"
                                              data-student-id="{{ student_data.student.id }}"
                                              data-current-status="FILL_IN"
                                              title="Click to edit status">
                                            <i class="fas fa-plus me-1"></i>Fill-in
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ student_data.last_status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if student_data.days_since_last %}
                                        {% if student_data.days_since_last > 14 %}
                                            <span class="badge bg-danger">{{ student_data.days_since_last }} days</span>
                                        {% elif student_data.days_since_last > 7 %}
                                            <span class="badge bg-warning text-dark">{{ student_data.days_since_last }} days</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ student_data.days_since_last }} days</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">Never</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">
                                    No students found for the current term.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Summary Statistics -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="metric-card bg-danger text-white">
                            <div class="metric-value">{{ all_students_overview|length|add:"-"|length }}</div>
                            <div class="metric-label">Very Behind (3+ owed)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-warning text-dark">
                            <div class="metric-value">{{ all_students_overview|length|add:"-"|length }}</div>
                            <div class="metric-label">Behind (1+ owed)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-success text-white">
                            <div class="metric-value">{{ all_students_overview|length|add:"-"|length }}</div>
                            <div class="metric-label">On Track</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-info text-white">
                            <div class="metric-value">{{ all_students_overview|length|add:"-"|length }}</div>
                            <div class="metric-label">Ahead (Credit)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Progress Overview -->
            <div class="analytics-card">
                <h3><i class="fas fa-users"></i> Student Progress Overview</h3>
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card bg-primary text-white">
                            <div class="metric-value">{{ student_analytics.total_students }}</div>
                            <div class="metric-label">Total Students</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-danger text-white">
                            <div class="metric-value">{{ student_analytics.students_behind }}</div>
                            <div class="metric-label">Behind Schedule</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-success text-white">
                            <div class="metric-value">{{ student_analytics.students_on_track }}</div>
                            <div class="metric-label">On Track</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card bg-info text-white">
                            <div class="metric-value">{{ student_analytics.students_ahead }}</div>
                            <div class="metric-label">Ahead of Schedule</div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Student Progress Distribution</h5>
                        <div class="chart-container">
                            <canvas id="studentProgressChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Skill Level Distribution</h5>
                        <div class="chart-container">
                            <canvas id="skillLevelChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Students Behind Schedule -->
                <div class="mt-4">
                    <h5>Students Most Behind Schedule</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Lessons Behind</th>
                                    <th>Attended</th>
                                    <th>Target</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for balance in student_analytics.lesson_balances|slice:":10" %}
                                <tr>
                                    <td>{{ balance.student.name }}</td>
                                    <td>
                                        <span class="badge bg-{% if balance.balance > 3 %}danger{% elif balance.balance > 1 %}warning{% else %}success{% endif %}">
                                            {{ balance.balance }}
                                        </span>
                                    </td>
                                    <td>{{ balance.attended }}</td>
                                    <td>{{ balance.target }}</td>
                                    <td>
                                        {% if balance.target > 0 %}
                                            {% widthratio balance.attended balance.target 100 as percentage %}
                                            <div class="progress progress-bar-custom">
                                                <div class="progress-bar bg-{% if percentage < 50 %}danger{% elif percentage < 80 %}warning{% else %}success{% endif %}" 
                                                     style="width: {{ percentage }}%">
                                                    {{ percentage }}%
                                                </div>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Coach Performance Metrics -->
            <div class="analytics-card">
                <h3><i class="fas fa-chalkboard-teacher"></i> Coach Performance Metrics</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Coach</th>
                                <th>Total Lessons</th>
                                <th>Students</th>
                                <th>Groups</th>
                                <th>Attendance Rate</th>
                                <th>Avg Group Size</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for coach_stat in coach_analytics %}
                            <tr>
                                <td>{{ coach_stat.coach.user.first_name }} {{ coach_stat.coach.user.last_name }}</td>
                                <td>{{ coach_stat.total_lessons }}</td>
                                <td>{{ coach_stat.total_students }}</td>
                                <td>{{ coach_stat.total_groups }}</td>
                                <td>
                                    <span class="badge bg-{% if coach_stat.attendance_rate >= 90 %}success{% elif coach_stat.attendance_rate >= 80 %}warning{% else %}danger{% endif %}">
                                        {{ coach_stat.attendance_rate }}%
                                    </span>
                                </td>
                                <td>{{ coach_stat.avg_group_size }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Utilization -->
            <div class="analytics-card">
                <h3><i class="fas fa-clock"></i> System Utilization</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Daily Utilization</h5>
                        <div class="chart-container">
                            <canvas id="dayUtilizationChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Time Slot Utilization</h5>
                        <div class="chart-container">
                            <canvas id="timeSlotChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Group Type Distribution</h5>
                        <div class="chart-container">
                            <canvas id="groupTypeChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Capacity Optimization</h5>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card bg-warning text-white">
                                    <div class="metric-value">{{ utilization_analytics.capacity_stats.underutilized }}</div>
                                    <div class="metric-label">Underutilized</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card bg-success text-white">
                                    <div class="metric-value">{{ utilization_analytics.capacity_stats.optimal }}</div>
                                    <div class="metric-label">Optimal</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card bg-danger text-white">
                                    <div class="metric-value">{{ utilization_analytics.capacity_stats.full }}</div>
                                    <div class="metric-label">Full</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card bg-info text-white">
                                    <div class="metric-value">{{ utilization_analytics.capacity_stats.total }}</div>
                                    <div class="metric-label">Total Groups</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Analytics -->
            <div class="analytics-card">
                <h3><i class="fas fa-chart-bar"></i> Attendance Analytics</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="metric-card bg-success text-white">
                            <div class="metric-value">{{ attendance_analytics.overall_attendance_rate }}%</div>
                            <div class="metric-label">Overall Attendance Rate</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card bg-primary text-white">
                            <div class="metric-value">{{ attendance_analytics.total_records }}</div>
                            <div class="metric-label">Total Records</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card bg-info text-white">
                            <div class="metric-value">{{ attendance_analytics.weekly_trends|length }}</div>
                            <div class="metric-label">Weeks Analyzed</div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>Attendance Status Breakdown</h5>
                        <div class="chart-container">
                            <canvas id="attendanceStatusChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Weekly Attendance Trends</h5>
                        <div class="chart-container">
                            <canvas id="weeklyTrendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Absence Reasons -->
                <div class="mt-4">
                    <h5>Top Absence Reasons</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Reason</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reason in attendance_analytics.absence_reasons %}
                                <tr>
                                    <td>{{ reason.reason_for_absence|default:"Not Specified" }}</td>
                                    <td>{{ reason.count }}</td>
                                    <td>
                                        {% if attendance_analytics.absence_reasons %}
                                            {% widthratio reason.count attendance_analytics.total_records 100 %}%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% endif %}
        </div>
    </div>
</div>

<!-- Chart Data as JSON -->
{{ student_analytics|json_script:"student-data" }}
{{ utilization_analytics|json_script:"utilization-data" }}
{{ attendance_analytics|json_script:"attendance-data" }}

<script>
// Filter helper functions
function setDateRange(range) {
    const today = new Date();
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let startDate, endDate;
    
    switch(range) {
        case 'week':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay() + 6);
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'term':
            // Use the current term dates - these would be passed from Django
            return; // Let the backend handle this
        default:
            return;
    }
    
    startDateInput.value = startDate.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
}

function clearFilters() {
    // Clear all form inputs
    const form = document.getElementById('analyticsFilterForm');
    const inputs = form.querySelectorAll('input[type="checkbox"], select');
    
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            input.checked = false;
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
    });
    
    // Submit the form to clear filters
    form.submit();
}

function exportData() {
    // Get current form data
    const form = document.getElementById('analyticsFilterForm');
    const formData = new FormData(form);
    
    // Add export parameter
    formData.append('export', 'csv');
    
    // Create a temporary form for export
    const exportForm = document.createElement('form');
    exportForm.method = 'GET';
    exportForm.action = window.location.pathname;
    
    // Add all form data as hidden inputs
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        exportForm.appendChild(input);
    }
    
    document.body.appendChild(exportForm);
    exportForm.submit();
    document.body.removeChild(exportForm);
}

// Student table filtering and sorting
function filterStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#studentsOverviewTable tbody .student-row');
    
    rows.forEach(row => {
        const studentName = row.cells[0].textContent.toLowerCase();
        const coach = row.cells[4].textContent.toLowerCase();
        const schoolClass = row.cells[6].textContent.toLowerCase();
        
        if (studentName.includes(searchTerm) || coach.includes(searchTerm) || schoolClass.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Table sorting functionality
function sortTable(sortBy) {
    const currentSort = new URLSearchParams(window.location.search).get('sort');
    const currentOrder = new URLSearchParams(window.location.search).get('order') || 'desc';
    
    let newOrder = 'desc';
    if (currentSort === sortBy && currentOrder === 'desc') {
        newOrder = 'asc';
    }
    
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.set('order', newOrder);
    
    window.location.href = url.toString();
}

// Add click handlers to sortable headers
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            sortTable(sortBy);
        });
    });
    
    // Add hover effect to sortable headers
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        });
        header.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});

// Inline status editing functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.editable-status').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function(e) {
            e.preventDefault();
            const studentId = this.getAttribute('data-student-id');
            const currentStatus = this.getAttribute('data-current-status');
            
            // Show status change dropdown
            showStatusChangeModal(studentId, currentStatus, this);
        });
    });
});

function showStatusChangeModal(studentId, currentStatus, badgeElement) {
    // Create a simple dropdown for status change
    const statusOptions = {
        'SICK_PRESENT': [
            {value: 'ABSENT', label: 'Change to Absent', color: 'danger'},
            {value: 'PRESENT', label: 'Change to Present', color: 'success'}
        ],
        'PRESENT': [
            {value: 'ABSENT', label: 'Change to Absent', color: 'danger'},
            {value: 'SICK_PRESENT', label: 'Change to Present Sick', color: 'warning'}
        ],
        'ABSENT': [
            {value: 'PRESENT', label: 'Change to Present', color: 'success'},
            {value: 'SICK_PRESENT', label: 'Change to Present Sick', color: 'warning'}
        ],
        'FILL_IN': [
            {value: 'ABSENT', label: 'Change to Absent', color: 'danger'},
            {value: 'PRESENT', label: 'Change to Present', color: 'success'}
        ]
    };
    
    const options = statusOptions[currentStatus] || [];
    
    if (options.length === 0) {
        alert('No status change options available for this student.');
        return;
    }
    
    // Create modal HTML
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Current status: <span class="badge bg-secondary">${currentStatus.replace('_', ' ')}</span></p>
                    <p>Change to:</p>
                    ${options.map(option => `
                        <button class="btn btn-outline-${option.color} btn-sm w-100 mb-2" 
                                onclick="changeStudentStatus('${studentId}', '${option.value}', this)">
                            ${option.label}
                        </button>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function changeStudentStatus(studentId, newStatus, buttonElement) {
    // For now, just show an alert - we'll implement the actual AJAX call later
    alert(`Status change functionality will be implemented in the next update.\n\nStudent ID: ${studentId}\nNew Status: ${newStatus}`);
    
    // Close the modal
    const modal = buttonElement.closest('.modal');
    const bootstrapModal = bootstrap.Modal.getInstance(modal);
    bootstrapModal.hide();
}

// Chart.js configurations
document.addEventListener('DOMContentLoaded', function() {
    // Get data from Django
    const studentData = JSON.parse(document.getElementById('student-data').textContent);
    const utilizationData = JSON.parse(document.getElementById('utilization-data').textContent);
    const attendanceData = JSON.parse(document.getElementById('attendance-data').textContent);

    // Student Progress Chart
    const studentProgressCtx = document.getElementById('studentProgressChart').getContext('2d');
    new Chart(studentProgressCtx, {
        type: 'doughnut',
        data: {
            labels: ['Behind Schedule', 'On Track', 'Ahead of Schedule'],
            datasets: [{
                data: [studentData.students_behind, studentData.students_on_track, studentData.students_ahead],
                backgroundColor: ['#dc3545', '#28a745', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Skill Level Chart
    const skillLevelCtx = document.getElementById('skillLevelChart').getContext('2d');
    const skillLabels = studentData.skill_distribution.map(item => item.skill_level);
    const skillCounts = studentData.skill_distribution.map(item => item.count);
    
    new Chart(skillLevelCtx, {
        type: 'bar',
        data: {
            labels: skillLabels,
            datasets: [{
                label: 'Students',
                data: skillCounts,
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Day Utilization Chart
    const dayUtilizationCtx = document.getElementById('dayUtilizationChart').getContext('2d');
    const dayLabels = utilizationData.day_utilization.map(item => item.day);
    const dayGroups = utilizationData.day_utilization.map(item => item.groups);
    const dayLessons = utilizationData.day_utilization.map(item => item.lessons);
    
    new Chart(dayUtilizationCtx, {
        type: 'bar',
        data: {
            labels: dayLabels,
            datasets: [{
                label: 'Groups',
                data: dayGroups,
                backgroundColor: '#28a745'
            }, {
                label: 'Lessons',
                data: dayLessons,
                backgroundColor: '#ffc107'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Time Slot Chart
    const timeSlotCtx = document.getElementById('timeSlotChart').getContext('2d');
    const timeLabels = utilizationData.time_slot_utilization.map(item => item.start_time);
    const timeCounts = utilizationData.time_slot_utilization.map(item => item.group_count);
    
    new Chart(timeSlotCtx, {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Groups',
                data: timeCounts,
                borderColor: '#007bff',
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Group Type Chart
    const groupTypeCtx = document.getElementById('groupTypeChart').getContext('2d');
    const typeLabels = utilizationData.group_type_distribution.map(item => item.group_type);
    const typeCounts = utilizationData.group_type_distribution.map(item => item.count);
    
    new Chart(groupTypeCtx, {
        type: 'pie',
        data: {
            labels: typeLabels,
            datasets: [{
                data: typeCounts,
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Attendance Status Chart
    const attendanceStatusCtx = document.getElementById('attendanceStatusChart').getContext('2d');
    const statusLabels = attendanceData.attendance_breakdown.map(item => item.status);
    const statusCounts = attendanceData.attendance_breakdown.map(item => item.count);
    
    new Chart(attendanceStatusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusCounts,
                backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Weekly Trends Chart
    const weeklyTrendsCtx = document.getElementById('weeklyTrendsChart').getContext('2d');
    const weekLabels = attendanceData.weekly_trends.map(item => {
        const date = new Date(item.week_start);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    const weekRates = attendanceData.weekly_trends.map(item => item.attendance_rate);
    
    new Chart(weeklyTrendsCtx, {
        type: 'line',
        data: {
            labels: weekLabels,
            datasets: [{
                label: 'Attendance Rate (%)',
                data: weekRates,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
});
</script>
{% endblock %}
