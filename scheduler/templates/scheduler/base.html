<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Chess Scheduler">
    <meta name="theme-color" content="#212529">
    <title>{% block title %}Somerset Chess Scheduler{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% load static %}{% static 'manifest.json' %}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><defs><style>.chess-piece { fill: %23000; }</style></defs><path class='chess-piece' d='M16 2c-1.1 0-2 .9-2 2v2h-2v2h2v2c-2.2 0-4 1.8-4 4h2c0-1.1.9-2 2-2s2 .9 2 2h2c0-2.2-1.8-4-4-4V8h2V6h-2V4c0-1.1-.9-2-2-2z'/><rect class='chess-piece' x='12' y='14' width='8' height='12'/><rect class='chess-piece' x='10' y='26' width='12' height='4'/></svg>" type="image/svg+xml">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'><defs><style>.chess-piece { fill: %23000; }</style></defs><path class='chess-piece' d='M16 2c-1.1 0-2 .9-2 2v2h-2v2h2v2c-2.2 0-4 1.8-4 4h2c0-1.1.9-2 2-2s2 .9 2 2h2c0-2.2-1.8-4-4-4V8h2V6h-2V4c0-1.1-.9-2-2-2z'/><rect class='chess-piece' x='12' y='14' width='8' height='12'/><rect class='chess-piece' x='10' y='26' width='12' height='4'/></svg>" type="image/svg+xml">
    
    <!-- Enhanced UI Styles -->
    <style>
        /* Fix dropdown visibility issues */
        select.form-control, select.form-select {
            background-color: #ffffff !important;
            color: #212529 !important;
            border: 1px solid #ced4da !important;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem !important;
        }
        
        select.form-control option, select.form-select option {
            background-color: #ffffff !important;
            color: #212529 !important;
            padding: 0.5rem !important;
        }
        
        select.form-control:focus, select.form-select:focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Improve checkbox and radio visibility */
        .form-check-input {
            width: 1.2em !important;
            height: 1.2em !important;
            margin-top: 0.1em !important;
        }
        
        .form-check-label {
            margin-left: 0.5rem !important;
            font-weight: 500 !important;
        }
        
        /* Enhanced form styling */
        .form-label {
            font-weight: 600 !important;
            color: #495057 !important;
            margin-bottom: 0.5rem !important;
        }
        
        .form-control, .form-select {
            border-radius: 0.375rem !important;
            border: 1px solid #ced4da !important;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Better button styling */
        .btn {
            border-radius: 0.375rem !important;
            font-weight: 500 !important;
            transition: all 0.15s ease-in-out !important;
        }
        
        .btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }
        
        /* Card enhancements */
        .card {
            border-radius: 0.5rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            transition: box-shadow 0.15s ease-in-out !important;
        }
        
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }
        
        /* Alert improvements */
        .alert {
            border-radius: 0.5rem !important;
            border: none !important;
            font-weight: 500 !important;
        }
        
        /* Badge improvements */
        .badge {
            font-weight: 500 !important;
            padding: 0.35em 0.65em !important;
        }
        
        /* Capacity warning badge styling */
        .badge.bg-warning.text-dark {
            background-color: #ffc107 !important;
            color: #212529 !important;
            border: 1px solid #ffb300 !important;
            font-weight: 600 !important;
            animation: subtle-pulse 2s ease-in-out infinite !important;
        }
        
        .badge.bg-warning.text-dark:hover {
            background-color: #ffb300 !important;
            transform: scale(1.05) !important;
            transition: all 0.2s ease !important;
        }
        
        @keyframes subtle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Table improvements */
        .table {
            border-radius: 0.5rem !important;
            overflow: hidden !important;
        }
        
        .table th {
            background-color: #f8f9fa !important;
            font-weight: 600 !important;
            border-bottom: 2px solid #dee2e6 !important;
        }
        
        /* Modal improvements */
        .modal-content {
            border-radius: 0.5rem !important;
            border: none !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        }
        
        /* Loading states */
        .btn.loading {
            pointer-events: none !important;
            opacity: 0.6 !important;
        }
        
        .btn.loading::after {
            content: "" !important;
            display: inline-block !important;
            width: 1rem !important;
            height: 1rem !important;
            margin-left: 0.5rem !important;
            border: 2px solid transparent !important;
            border-top-color: currentColor !important;
            border-radius: 50% !important;
            animation: spin 1s linear infinite !important;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile-first responsive improvements */
        @media (max-width: 768px) {
            .container-fluid {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            .btn-group-vertical .btn {
                margin-bottom: 0.5rem !important;
            }
            
            /* Larger touch targets for mobile */
            .btn {
                min-height: 44px !important;
                padding: 0.75rem 1rem !important;
                font-size: 1rem !important;
            }
            
            .btn-sm {
                min-height: 38px !important;
                padding: 0.5rem 0.75rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Better form controls on mobile */
            .form-control, .form-select {
                min-height: 44px !important;
                padding: 0.75rem !important;
                font-size: 1rem !important;
            }
            
            /* Improved table responsiveness */
            .table-responsive {
                font-size: 0.9rem !important;
            }
            
            .table td, .table th {
                padding: 0.75rem 0.5rem !important;
            }
            
            /* Better modal sizing on mobile */
            .modal-dialog {
                margin: 1rem !important;
                max-width: calc(100% - 2rem) !important;
            }
            
            /* Improved navigation */
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem !important;
                font-size: 1rem !important;
            }
            
            /* Better card spacing */
            .card {
                margin-bottom: 1rem !important;
            }
            
            /* Improved badge visibility */
            .badge {
                font-size: 0.8rem !important;
                padding: 0.4em 0.7em !important;
            }
            
            /* Better alert spacing */
            .alert {
                margin-bottom: 1rem !important;
                padding: 1rem !important;
            }
        }
        
        /* Extra small devices (phones, less than 576px) */
        @media (max-width: 575.98px) {
            .container, .container-fluid {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            /* Stack buttons vertically on very small screens */
            .btn-group {
                display: flex !important;
                flex-direction: column !important;
            }
            
            .btn-group .btn {
                margin-bottom: 0.5rem !important;
                border-radius: 0.375rem !important;
            }
            
            /* Smaller text for very small screens */
            .table {
                font-size: 0.8rem !important;
            }
            
            /* Better form layout */
            .row .col-md-6, .row .col-md-4, .row .col-md-3 {
                margin-bottom: 1rem !important;
            }
        }
        
        /* Touch-friendly improvements for all devices */
        .clickable, .btn, .nav-link, .dropdown-item {
            cursor: pointer !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
        }
        
        /* Prevent zoom on input focus (iOS) */
        input[type="text"], input[type="email"], input[type="password"], 
        input[type="number"], input[type="date"], input[type="time"], 
        select, textarea {
            font-size: 16px !important;
        }
        
        @media (max-width: 768px) {
            input[type="text"], input[type="email"], input[type="password"], 
            input[type="number"], input[type="date"], input[type="time"], 
            select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Clean Notes Form Styling */
        .note-form-container {
            max-width: 100%;
        }
        
        .note-form {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .note-form h6 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Ensure form controls have proper styling */
        .note-form .form-select,
        .note-form .form-control {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .note-form .form-select:focus,
        .note-form .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        /* Mobile-Friendly Checkbox Container - Simple & Contained */
        .topics-checkbox-grid {
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            width: 100%;
            box-sizing: border-box;
            /* Simple container - no complex grid */
        }
        
        .topics-checkbox-grid ul {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .topics-checkbox-grid li {
            display: flex !important;
            align-items: center !important;
            padding: 0.5rem !important;
            margin: 0 !important;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            flex: 0 0 auto;
            min-width: 200px;
            max-width: 300px;
        }
        
        .topics-checkbox-grid li:hover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .topics-checkbox-grid input[type="checkbox"] {
            margin-right: 0.75rem !important;
            margin-top: 0 !important;
            width: 1.2em !important;
            height: 1.2em !important;
            cursor: pointer;
        }
        
        .topics-checkbox-grid label {
            cursor: pointer !important;
            user-select: none !important;
            margin: 0 !important;
            font-weight: 500 !important;
            flex: 1 !important;
            font-size: 0.9rem;
        }
        
        .topics-checkbox-grid input[type="checkbox"]:checked + label {
            font-weight: 600 !important;
            color: #0d6efd !important;
        }
        
        .topics-checkbox-grid li:has(input:checked) {
            background-color: #e7f3ff;
            border-color: #0d6efd;
        }
        
        /* Mobile responsiveness for notes form */
        @media (max-width: 768px) {
            .note-form .row .col-md-6 {
                margin-bottom: 1rem;
            }
            
            .note-form h6 {
                font-size: 1rem;
            }
            
            .topics-checkbox-grid {
                grid-template-columns: 1fr;
                /* Removed max-height to show all options on mobile too */
            }
            
            .topics-checkbox-grid li {
                padding: 0.75rem !important;
            }
            
            .topics-checkbox-grid label {
                font-size: 1rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .topics-checkbox-grid {
                padding: 0.75rem;
                /* Removed max-height to show all options on extra small screens too */
            }
            
            .topics-checkbox-grid li {
                padding: 0.5rem !important;
            }
        }
    </style>

</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'dashboard' %}">Chess Scheduler</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'manage-availability' %}">Availability</a>
                    </li>
                    {% if user.is_authenticated and user.coach.is_head_coach or user.is_staff %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'analytics-dashboard' %}">
                            <i class="bi bi-graph-up me-1"></i>Analytics
                        </a>
                    </li>
                    {% endif %}
                    {% if user.is_staff %}
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/">
                            <i class="bi bi-gear-fill me-1"></i>Admin Panel
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}">Logout ({{ user.username }})</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>
    
    <div class="modal fade" id="report-modal" tabindex="-1" aria-labelledby="reportModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Student Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="report-content">
                    </div>
            </div>
        </div>
    </div>
      
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <script>
        // Get a reference to the Bootstrap modal
        const reportModal = new bootstrap.Modal(document.getElementById('report-modal'));
        
        // Listen for HTMX events to open the modal after content is loaded
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'report-content') {
                reportModal.show();
            }
        });

        // 🔍 COMPREHENSIVE NOTES DEBUGGING
        console.log('🚀 Somerset Chess App - Notes Debugging Enabled');
        
        // Debug all note button clicks
        document.addEventListener('click', function(event) {
            if (event.target.closest('.note-btn')) {
                const btn = event.target.closest('.note-btn');
                console.log('🎯 Note button clicked:', {
                    action: btn.dataset.action,
                    noteId: btn.dataset.noteId,
                    recordId: btn.dataset.recordId,
                    studentName: btn.dataset.studentName,
                    url: btn.getAttribute('hx-get'),
                    target: btn.getAttribute('hx-target') || 'default'
                });
            }
        });

        // 📡 HTMX Event Debugging for Notes
        document.body.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.path.includes('/note/')) {
                console.log('📤 HTMX Request (Notes):', {
                    method: event.detail.verb,
                    url: event.detail.path,
                    target: event.detail.target.id || event.detail.target.tagName,
                    headers: event.detail.headers
                });
            }
        });

        document.body.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                console.log('⏳ HTMX Before Request (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    element: event.detail.elt.tagName + (event.detail.elt.className ? '.' + event.detail.elt.className.replace(/\s+/g, '.') : ''),
                    timestamp: new Date().toISOString()
                });
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                console.log('📥 HTMX After Request (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    status: event.detail.xhr.status,
                    statusText: event.detail.xhr.statusText,
                    responseLength: event.detail.xhr.responseText ? event.detail.xhr.responseText.length : 0,
                    timestamp: new Date().toISOString()
                });
                
                // 🔍 LOG ACTUAL SERVER RESPONSE CONTENT
                console.log('📄 Server Response Content (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    responseText: event.detail.xhr.responseText,
                    responseHTML: event.detail.xhr.responseText ? event.detail.xhr.responseText.substring(0, 1000) + (event.detail.xhr.responseText.length > 1000 ? '...' : '') : 'No content',
                    contentType: event.detail.xhr.getResponseHeader('Content-Type'),
                    hasContent: !!event.detail.xhr.responseText && event.detail.xhr.responseText.trim().length > 0
                });
                
                if (event.detail.xhr.status !== 200) {
                    console.error('❌ HTMX Request Failed (Notes):', {
                        status: event.detail.xhr.status,
                        response: event.detail.xhr.responseText,
                        url: event.detail.pathInfo.requestPath
                    });
                }
            }
        });

        document.body.addEventListener('htmx:responseError', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                console.error('💥 HTMX Response Error (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    status: event.detail.xhr.status,
                    error: event.detail.xhr.statusText,
                    response: event.detail.xhr.responseText
                });
            }
        });

        document.body.addEventListener('htmx:sendError', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                console.error('🚫 HTMX Send Error (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    error: event.detail.error
                });
            }
        });

        document.body.addEventListener('htmx:beforeSwap', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                // Capture current DOM state before swap
                const targetElement = event.detail.target;
                const currentHTML = targetElement.innerHTML;
                
                console.log('🔄 HTMX Before Swap (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    target: event.detail.target.id || event.detail.target.tagName,
                    swapStyle: event.detail.swapStyle,
                    responseLength: event.detail.xhr.responseText ? event.detail.xhr.responseText.length : 0,
                    currentTargetHTML: currentHTML.substring(0, 500) + (currentHTML.length > 500 ? '...' : ''),
                    targetElementId: targetElement.id,
                    targetElementClass: targetElement.className
                });
            }
        });

        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.pathInfo.requestPath.includes('/note/')) {
                // Capture new DOM state after swap
                const targetElement = event.detail.target;
                const newHTML = targetElement.innerHTML;
                
                console.log('✅ HTMX After Swap (Notes):', {
                    url: event.detail.pathInfo.requestPath,
                    target: event.detail.target.id || event.detail.target.tagName,
                    timestamp: new Date().toISOString(),
                    newTargetHTML: newHTML.substring(0, 500) + (newHTML.length > 500 ? '...' : ''),
                    targetElementVisible: targetElement.offsetHeight > 0 && targetElement.offsetWidth > 0,
                    targetElementStyle: window.getComputedStyle(targetElement).display
                });
                
                // Check if note display elements were added
                const noteDisplays = event.detail.target.querySelectorAll('.lesson-note-display');
                const noteForms = event.detail.target.querySelectorAll('.lesson-note-form');
                const debugAlerts = event.detail.target.querySelectorAll('.alert');
                
                console.log('📋 Notes Content After Swap:', {
                    noteDisplays: noteDisplays.length,
                    noteForms: noteForms.length,
                    hasNoteButtons: event.detail.target.querySelectorAll('.note-btn').length,
                    debugAlerts: debugAlerts.length,
                    allElements: event.detail.target.children.length
                });
                
                // Log each note display found
                noteDisplays.forEach((display, index) => {
                    console.log(`📝 Note Display ${index + 1}:`, {
                        noteId: display.dataset.noteId,
                        debugInfo: display.dataset.debugInfo,
                        visible: display.offsetHeight > 0 && display.offsetWidth > 0,
                        innerHTML: display.innerHTML.substring(0, 200) + '...'
                    });
                });
                
                // Log debug alerts
                debugAlerts.forEach((alert, index) => {
                    console.log(`🚨 Debug Alert ${index + 1}:`, {
                        className: alert.className,
                        text: alert.textContent.trim(),
                        visible: alert.offsetHeight > 0 && alert.offsetWidth > 0
                    });
                });
            }
        });

        // 🎯 Form Submission Debugging
        document.addEventListener('submit', function(event) {
            if (event.target.closest('.note-form')) {
                console.log('📝 Note form submitted:', {
                    action: event.target.action,
                    method: event.target.method,
                    formData: new FormData(event.target),
                    timestamp: new Date().toISOString()
                });
            }
        });

        // 🔍 Page Load Debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 Page loaded - Notes debugging active');
            
            // Count existing note elements
            const noteButtons = document.querySelectorAll('.note-btn');
            const noteDisplays = document.querySelectorAll('.lesson-note-display');
            const noteForms = document.querySelectorAll('.lesson-note-form');
            
            console.log('📊 Initial Notes Count:', {
                noteButtons: noteButtons.length,
                noteDisplays: noteDisplays.length,
                noteForms: noteForms.length
            });
            
            // Log each note button
            noteButtons.forEach((btn, index) => {
                console.log(`🔘 Note Button ${index + 1}:`, {
                    action: btn.dataset.action,
                    noteId: btn.dataset.noteId,
                    recordId: btn.dataset.recordId,
                    studentName: btn.dataset.studentName,
                    url: btn.getAttribute('hx-get')
                });
            });
        });

        // 🎯 VISUAL SLOT FINDER SYSTEM
        let slotFinderMode = {
            active: false,
            studentId: null,
            studentName: null,
            availableSlots: []
        };

        // Handle Find Slots button clicks
        document.addEventListener('click', function(event) {
            if (event.target.closest('.find-slots-btn')) {
                event.preventDefault();
                const btn = event.target.closest('.find-slots-btn');
                const studentId = btn.dataset.studentId;
                const studentName = btn.dataset.studentName;
                
                console.log('🔍 Find Slots clicked for:', studentName, 'ID:', studentId);
                
                if (slotFinderMode.active && slotFinderMode.studentId === studentId) {
                    // Exit slot finder mode
                    exitSlotFinderMode();
                } else {
                    // Enter slot finder mode for this student
                    enterSlotFinderMode(studentId, studentName);
                }
            }
        });

        function enterSlotFinderMode(studentId, studentName) {
            console.log('🎯 Entering slot finder mode for:', studentName);
            
            // Show loading state
            showSlotFinderBanner(`Finding available slots for ${studentName}...`, true);
            
            // Fetch available slots
            fetch(`/api/available-slots/${studentId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    slotFinderMode = {
                        active: true,
                        studentId: studentId,
                        studentName: studentName,
                        availableSlots: data.available_slots
                    };
                    
                    console.log('✅ Found', data.available_slots.length, 'available slots');
                    showSlotFinderBanner(`Found ${data.available_slots.length} available slots for ${studentName}`, false);
                    highlightAvailableSlots(data.available_slots);
                    updateFindSlotsButtons();
                } else {
                    console.error('❌ Error finding slots:', data.error);
                    showSlotFinderBanner(`Error: ${data.error}`, false, true);
                    setTimeout(exitSlotFinderMode, 3000);
                }
            })
            .catch(error => {
                console.error('💥 Network error:', error);
                showSlotFinderBanner('Network error - please try again', false, true);
                setTimeout(exitSlotFinderMode, 3000);
            });
        }

        function exitSlotFinderMode() {
            console.log('🚪 Exiting slot finder mode');
            
            slotFinderMode = {
                active: false,
                studentId: null,
                studentName: null,
                availableSlots: []
            };
            
            hideSlotFinderBanner();
            clearSlotHighlights();
            updateFindSlotsButtons();
        }

        function showSlotFinderBanner(message, loading = false, error = false) {
            // Remove existing banner
            const existingBanner = document.querySelector('.slot-finder-banner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            // Create new banner
            const banner = document.createElement('div');
            banner.className = `alert slot-finder-banner d-flex justify-content-between align-items-center ${error ? 'alert-danger' : 'alert-info'}`;
            banner.style.cssText = 'position: sticky; top: 0; z-index: 1000; margin-bottom: 1rem;';
            
            const messageSpan = document.createElement('span');
            messageSpan.innerHTML = loading ? `<i class="bi bi-hourglass-split me-2"></i>${message}` : `<i class="bi bi-search me-2"></i>${message}`;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-sm btn-outline-secondary';
            closeBtn.innerHTML = '<i class="bi bi-x"></i> Cancel';
            closeBtn.onclick = exitSlotFinderMode;
            
            banner.appendChild(messageSpan);
            if (!loading) {
                banner.appendChild(closeBtn);
            }
            
            // Insert at top of main content
            const main = document.querySelector('main');
            main.insertBefore(banner, main.firstChild);
        }

        function hideSlotFinderBanner() {
            const banner = document.querySelector('.slot-finder-banner');
            if (banner) {
                banner.remove();
            }
        }

        function highlightAvailableSlots(availableSlots) {
            console.log('🎨 Highlighting', availableSlots.length, 'available slots');
            
            // Clear existing highlights
            clearSlotHighlights();
            
            // Add highlights and click handlers
            availableSlots.forEach(slot => {
                // Find lesson cards that match this slot
                const lessonCards = document.querySelectorAll('.card');
                lessonCards.forEach(card => {
                    const header = card.querySelector('.card-header h5');
                    if (header && header.textContent.trim() === slot.group_name) {
                        // Add visual highlight
                        card.classList.add('slot-finder-available');
                        card.style.cssText = 'border: 3px solid #28a745 !important; box-shadow: 0 0 15px rgba(40, 167, 69, 0.3) !important; position: relative;';
                        
                        // Add "Add Student" button
                        const addBtn = document.createElement('button');
                        addBtn.className = 'btn btn-success btn-sm slot-finder-add-btn';
                        addBtn.innerHTML = `<i class="bi bi-plus-circle me-1"></i>Add ${slotFinderMode.studentName}`;
                        addBtn.dataset.groupId = slot.group_id;
                        addBtn.style.cssText = 'position: absolute; top: 10px; right: 10px; z-index: 10;';
                        
                        // Add click handler
                        addBtn.onclick = (e) => {
                            e.preventDefault();
                            moveStudentToSlot(slot.group_id, slot.group_name);
                        };
                        
                        card.style.position = 'relative';
                        card.appendChild(addBtn);
                        
                        // Add capacity info if overfull
                        if (!slot.has_space) {
                            const capacityBadge = document.createElement('span');
                            capacityBadge.className = 'badge bg-warning text-dark position-absolute';
                            capacityBadge.style.cssText = 'top: 45px; right: 10px; z-index: 10;';
                            capacityBadge.innerHTML = `${slot.current_size}/${slot.max_capacity} (Overfull)`;
                            card.appendChild(capacityBadge);
                        }
                    }
                });
            });
        }

        function clearSlotHighlights() {
            // Remove all slot finder styling and buttons
            const highlightedCards = document.querySelectorAll('.slot-finder-available');
            highlightedCards.forEach(card => {
                card.classList.remove('slot-finder-available');
                card.style.cssText = '';
                
                // Remove add buttons
                const addBtns = card.querySelectorAll('.slot-finder-add-btn');
                addBtns.forEach(btn => btn.remove());
                
                // Remove capacity badges
                const capacityBadges = card.querySelectorAll('.badge.bg-warning.position-absolute');
                capacityBadges.forEach(badge => badge.remove());
            });
        }

        function updateFindSlotsButtons() {
            const findSlotsBtns = document.querySelectorAll('.find-slots-btn');
            findSlotsBtns.forEach(btn => {
                const studentId = btn.dataset.studentId;
                const isActive = slotFinderMode.active && slotFinderMode.studentId === studentId;
                
                if (isActive) {
                    btn.className = 'btn btn-sm btn-warning find-slots-btn';
                    btn.innerHTML = '<i class="bi bi-x me-1"></i>Cancel';
                } else {
                    btn.className = 'btn btn-sm btn-outline-info find-slots-btn';
                    btn.innerHTML = '<i class="bi bi-search me-1"></i>Find Slots';
                }
            });
        }

        function moveStudentToSlot(groupId, groupName) {
            console.log('🚀 Moving student to slot:', groupId, groupName);
            
            // Show loading state
            showSlotFinderBanner(`Moving ${slotFinderMode.studentName} to ${groupName}...`, true);
            
            // Make the move request
            fetch(`/api/move-student/${slotFinderMode.studentId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    group_id: groupId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Student moved successfully');
                    showSlotFinderBanner(`✅ Successfully moved ${slotFinderMode.studentName} to ${groupName}!`, false);
                    
                    // Exit slot finder mode after 2 seconds and refresh page
                    setTimeout(() => {
                        exitSlotFinderMode();
                        window.location.reload();
                    }, 2000);
                } else {
                    console.error('❌ Error moving student:', data.error);
                    showSlotFinderBanner(`Error: ${data.error}`, false, true);
                    setTimeout(exitSlotFinderMode, 3000);
                }
            })
            .catch(error => {
                console.error('💥 Network error:', error);
                showSlotFinderBanner('Network error - please try again', false, true);
                setTimeout(exitSlotFinderMode, 3000);
            });
        }
    </script>
    
    {# This is the crucial placeholder for page-specific scripts #}
    {% block extra_js %}{% endblock %}

</body>
</html>
