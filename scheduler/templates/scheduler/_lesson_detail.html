<div id="lesson-{{ lesson.pk }}" hx-target="this" hx-swap="outerHTML">

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">{{ lesson.scheduled_group.name }}</h5>
                <small class="text-muted">{{ lesson.scheduled_group.time_slot }}</small>
            </div>
            <a href="{% url 'manage-lesson' lesson.pk %}" class="btn btn-outline-primary btn-sm">
                Manage / Find Fill-in
            </a>
        </div>
        <ul class="list-group list-group-flush">
            {% for record in lesson.attendancerecord_set.all %}
            <li class="list-group-item{% if record.has_conflict %} border-danger border-2{% endif %}" id="student-row-{{ record.pk }}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <a href="{% url 'student-report' record.enrollment.student.pk lesson.scheduled_group.term.pk %}?date={{ lesson.lesson_date|date:'Y-m-d' }}{% if view_coach and view_coach.id != user.coach.id %}&coach={{ view_coach.id }}{% endif %}"
                           class="student-link fw-bold text-dark text-decoration-none">
                            {{ record.enrollment.student }}
                            <small class="text-muted">({{ record.enrollment.get_enrollment_type_display }})</small>
                        </a>
                        
                        {% if record.status == 'FILL_IN' %}
                            <span class="badge bg-info">Fill-in</span>
                        {% endif %}
                        
                        {% if record.has_conflict %}
                            <span class="badge bg-danger text-white" title="{{ record.conflict_description }}">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>CONFLICT
                            </span>
                            <small class="text-danger fst-italic">{{ record.conflict_type|title }} conflict</small>
                        {% endif %}
                    </div>
                </div>

                <div class="controls d-flex flex-wrap align-items-center gap-2">
                    {% if record.status == 'PRESENT' or record.status == 'FILL_IN' %}
                        <button class="btn btn-sm btn-success fw-bold" hx-post="{% url 'mark-attendance' record.pk 'PENDING' %}" title="Click to undo">
                            <i class="bi bi-check-circle-fill me-1"></i>{{ record.get_status_display }}
                        </button>
                    {% elif record.status == 'SICK_PRESENT' %}
                        <button class="btn btn-sm btn-success fw-bold" hx-post="{% url 'mark-attendance' record.pk 'PENDING' %}" title="Click to undo">
                            <i class="bi bi-thermometer-half me-1"></i>{{ record.get_status_display }}
                        </button>
                    {% elif record.status == 'REFUSES_PRESENT' %}
                        <button class="btn btn-sm btn-warning fw-bold" hx-post="{% url 'mark-attendance' record.pk 'PENDING' %}" title="Click to undo">
                            <i class="bi bi-exclamation-triangle me-1"></i>{{ record.get_status_display }}
                        </button>
                    {% elif record.status == 'ABSENT' %}
                        <button class="btn btn-sm btn-danger fw-bold" hx-post="{% url 'mark-attendance' record.pk 'PENDING' %}" title="Click to undo">
                            <i class="bi bi-x-circle-fill me-1"></i>Absent
                        </button>

                        {% if record.reason_for_absence %}
                            <span class="badge bg-light text-dark ms-2">{{ record.get_reason_for_absence_display }}</span>
                        {% else %}
                            <div class="reason-buttons d-flex gap-1 mt-1">
                            {% for reason_code, reason_display in record.get_absence_reasons %}
                                <button class="btn btn-xs btn-outline-secondary" hx-post="{% url 'save-reason' record.pk reason_code %}" title="Mark as {{ reason_display }}">{{ reason_display }}</button>
                            {% endfor %}
                            </div>
                        {% endif %}
                    {% else %} {# Status is PENDING #}
                        <button class="btn btn-sm btn-outline-success fw-semibold" hx-post="{% url 'mark-attendance' record.pk 'PRESENT' %}">
                            <i class="bi bi-check-circle me-1"></i>Present
                        </button>
                        <button class="btn btn-sm btn-outline-success fw-semibold" hx-post="{% url 'mark-attendance' record.pk 'SICK_PRESENT' %}" title="Student was sick but marked present">
                            <i class="bi bi-thermometer-half me-1"></i>Sick Present
                        </button>
                        <button class="btn btn-sm btn-outline-warning fw-semibold" hx-post="{% url 'mark-attendance' record.pk 'REFUSES_PRESENT' %}" title="Student present but refused to participate">
                            <i class="bi bi-exclamation-triangle me-1"></i>Present Refuses
                        </button>
                        <button class="btn btn-sm btn-outline-danger fw-semibold" hx-post="{% url 'mark-attendance' record.pk 'ABSENT' %}">
                            <i class="bi bi-x-circle me-1"></i>Absent
                        </button>
                    {% endif %}

                    {# --- Notes Button Logic --- #}
                    {% with lesson_note=record.lessonnote|default:None %}
                        {% if lesson_note %}
                            <button class="btn btn-sm btn-outline-info note-btn" 
                                    hx-get="{% url 'view-note' lesson_note.pk %}" 
                                    title="View note"
                                    data-action="view"
                                    data-note-id="{{ lesson_note.pk }}"
                                    data-student-name="{{ record.enrollment.student.first_name }}"
                                    onclick="console.log('ðŸ‘ï¸ Viewing note', this.dataset.noteId, 'for', this.dataset.studentName);">
                                <i class="bi bi-eye me-1"></i>View Note
                            </button>
                            <button class="btn btn-sm btn-outline-secondary note-btn" 
                                    hx-get="{% url 'edit-note' lesson_note.pk %}" 
                                    title="Edit note"
                                    data-action="edit"
                                    data-note-id="{{ lesson_note.pk }}"
                                    data-student-name="{{ record.enrollment.student.first_name }}"
                                    onclick="console.log('âœï¸ Editing note', this.dataset.noteId, 'for', this.dataset.studentName);">
                                <i class="bi bi-pencil me-1"></i>Edit Note
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-outline-primary note-btn" 
                                    hx-get="{% url 'create-note' record.pk %}" 
                                    title="Add note"
                                    data-action="create"
                                    data-record-id="{{ record.pk }}"
                                    data-student-name="{{ record.enrollment.student.first_name }}"
                                    onclick="console.log('âž• Creating note for record', this.dataset.recordId, '(' + this.dataset.studentName + ')');">
                                <i class="bi bi-plus me-1"></i>Add Note
                            </button>
                        {% endif %}
                    {% endwith %}
                </div>

                {# Note editing form - show when editing_note_id matches this record's note #}
                {% if editing_note_id and lesson_note and lesson_note.pk == editing_note_id %}
                    <div class="mt-3 p-3 bg-light border rounded">
                        <h6>Edit Note for {{ record.enrollment.student }}</h6>
                        {% if note_form %}
                            <form hx-post="{% url 'edit-note' lesson_note.pk %}" hx-target="#lesson-{{ lesson.pk }}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="{{ note_form.student_understanding.id_for_label }}" class="form-label">Student Understanding:</label>
                                    {{ note_form.student_understanding }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ note_form.topics_covered.id_for_label }}" class="form-label">Topics Covered:</label>
                                    {{ note_form.topics_covered }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ note_form.coach_comments.id_for_label }}" class="form-label">Coach Comments:</label>
                                    {{ note_form.coach_comments }}
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-sm">Save Note</button>
                                    <button type="button" class="btn btn-secondary btn-sm" hx-get="{% url 'view-note' lesson_note.pk %}" hx-target="#lesson-{{ lesson.pk }}">Cancel</button>
                                </div>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}
            </li>
            {% empty %}
            <li class="list-group-item text-muted">
                No students are scheduled for this lesson.
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
